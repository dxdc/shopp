jQuery(document).ready(function(e){e.template("editor",e("#editor")),e.template("conditional",e("#conditional")),e.template("localrate",e("#localrate")),e.template("property-menu",e("#property-menu")),e.template("countries-menu",e("#countries-menu"));var a=!1,t=e("#no-taxrates");e("#taxrates a.edit, #addrate").click(function(n){n&&n.preventDefault(),t.hide();var l=e(this),o=rates.length,i=0,d=l.parents("tr").hide(),s=e.getQueryVar("id",l.attr("href")),c=rates[s]?rates[s]:{},u=e.extend({id:s?s:o++,rate:0,compound:"off",country:!1,zone:!1,logic:"any",rules:[]},c),p=e.tmpl("editor",u),f=p.find("div.conditionals").hide().removeClass("no-conditions"),h=f.find("ul"),m=(p.find("select.logic").val(u.logic),p.find("select.country")),v=p.find("select.zone").hide().removeClass("no-zones"),g=p.find(".local-rates").hide().removeClass("no-local-rates"),y=g.find("ul"),w=p.find(".has-locals"),b=p.find(".add-locals").hide().removeClass("has-local-rates"),x=p.find(".rm-locals").hide().removeClass("no-local-rates"),C=p.find("button.upload"),k=(C.parent(),p.find("p.instructions")),z=p.find("a.cancel"),_=(p.find("#tax-rate").change(function(){this.value=asPercent(this.value,!1,4)}).change(),p.find("#tax-compound").attr("checked","on"==u.compound),p.find("button.add"));l.rules=[],m.html(e.tmpl("countries-menu")).val(u.country).change(function(a){var t=e(this),n="",l=!!zones[t.val()]&&zones[t.val()];0!=l?(n+='<option value=""></option>',e.each(l,function(e,a){n+='<option value="'+e+'">'+a+"</option>"}),v.html(n).val(u.zone).show()):v.empty().hide()}).change(),l.cancel=function(e){e&&e.preventDefault(),a=!1,p.remove(),d.fadeIn("fast"),t.size()>0&&t.show()},z.click(l.cancel),l.addlocals=function(e){e&&e.preventDefault(),b.hide(),x.show(),w.val("true"),g.hide().removeClass("no-local-rates").show()},b.click(l.addlocals),l.rmlocals=function(e){e&&e.preventDefault(),x.hide(),b.show(),w.val("false"),g.fadeOut("fast")},x.click(l.rmlocals),C.upload({name:"ratefile",action:ajaxurl,params:{action:"shopp_upload_local_taxes",_wpnonce:e("#_wpnonce").val()},accept:"text/plain,text/xml",maxfilesize:"1048576",onSubmit:function(){y.empty(),k.empty().removeClass("error"),C.attr("disabled",!0).addClass("updating").parent().css("width","100%")},onComplete:function(a){C.removeAttr("disabled").removeClass("updating");try{r=e.parseJSON(a),r.error?k.addClass("error").html(r.error):l.addlocals(r)}catch(e){alert("LOCAL_RATES_UPLOADERR")}}}),l.addlocalrate=function(a,t){var n={id:u.id,localename:a,localerate:asNumber(t)};e.tmpl("localrate",n).appendTo(y)},l.addlocals=function(a){e.each(a,function(e,a){l.addlocalrate(e,a)}),k.empty()},u.haslocals?(void 0!=u.locals&&l.addlocals(u.locals),g.show(),x.show()):b.show(),l.addrule=function(a,t,n){a&&a.preventDefault(),t||(t=i),n||(n={}),n.id=u.id,n.ruleid=t,n.rulevalue=n.v;var o=e.tmpl("conditional",n).appendTo(h),r=o.find("input.value"),d=(o.find("select.property").html(e.tmpl("property-menu")).val(n.p).change(function(){r.unbind("keydown").unbind("keypress").suggest(suggurl+"&action=shopp_suggestions&t="+e(this).val(),{delay:500,minchars:2,format:"json"})}).change(),o.find("button.delete").click(function(e){e&&e.preventDefault(),o.remove(),l.rules.pop(),0==l.rules.length&&f.hide()}).hide());addrulebtn=o.find("button.add").click(l.addrule),o.hover(function(){d.show()},function(){d.fadeOut("fast")}),f.show(),i++,l.rules.push(i)},_.click(l.addrule),u.rules.length>0&&e.each(u.rules,function(e,a){l.addrule(!1,e,a)}),d.size()>0?p.insertAfter(d):p.prependTo("#taxrates-table"),quickSelects(),a=l})});